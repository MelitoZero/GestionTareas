<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Lista de Tareas</title>
  <link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet">
  <link rel="stylesheet" href="css/EstiloListaT.css">
</head>
<body>
  <div class="container">
    <aside id="sidebar">
      <h1>Tilin Manager</h1>
      <button id="mobile-menu-toggle"><i class='bx bx-menu'></i></button>
      <ul>
        <li><a href="dashboard.html"><i class='bx bx-home'></i> Inicio</a></li>
        <li><a href="perfil.html"><i class='bx bx-list-ul'></i> perfil</a></li>
        <li><a href="calendario.html"><i class='bx bx-calendar'></i> boton para ver el 404</a></li>
      </ul>
    </aside>
    <main id="content">
      <header>
        <h2>Lista de Tareas</h2>
        <div class="notifications">
          <button id="notification-toggle"><i class='bx bx-bell'></i></button>
          <div id="notification-panel">
            <button id="close-notifications">Cerrar</button>
            <p>No hay notificaciones nuevas.</p>
          </div>
        </div>
      </header>

      <div class="task-buttons">
        <button id="btn-add-task" class="btn btn-primary"><i class='bx bx-plus'></i> Nueva Tarea</button>
        <button id="btn-add-list" class="btn btn-outline"><i class='bx bx-list-ul'></i> Nueva Lista</button>
      </div>

      <div class="filters">
        <div class="filter-group">
          <label for="filter-status">Estado:</label>
          <select id="filter-status" class="filter-select">
            <option value="all">Todos</option>
            <option value="pending">Pendiente</option>
            <option value="completed">Completada</option>
          </select>
        </div>

        <div class="filter-group">
          <label for="filter-category">Categoría:</label>
          <select id="filter-category" class="filter-select">
            <option value="all">Todas</option>
            <option value="work">Trabajo</option>
            <option value="personal">Personal</option>
            <option value="study">Estudio</option>
          </select>
        </div>

        <div class="search-group">
          <input type="text" id="search-task" placeholder="Buscar tarea...">
          <button id="btn-search" class="btn-icon"><i class='bx bx-search'></i></button>
        </div>
      </div>

      <div id="no-tasks-message" class="no-tasks-message">
        <p>No hay tareas que coincidan con los filtros seleccionados.</p>
      </div>

      <div id="task-table-container" class="task-table-container">
        <table id="task-list" class="task-table">
          <thead>
            <tr>
              <th>Tarea</th>
              <th>Categoría</th>
              <th>Fecha Límite</th>
              <th>Estado</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody>
            <!-- Las tareas se insertarán aquí dinámicamente -->
          </tbody>
        </table>
      </div>

      <!-- Modal para añadir/editar tareas -->
      <div class="modal" id="task-modal">
        <div class="modal-content">
          <div class="modal-header">
            <h2 class="modal-title" id="modal-title">Añadir Tarea</h2>
            <button class="close-modal" id="close-modal">&times;</button>
          </div>
          <form id="task-form">
            <div class="modal-body">
              <input type="hidden" id="task-id">
              <div class="form-group">
                <label for="task-name-input">Nombre de la Tarea:</label>
                <input type="text" id="task-name-input" required>
              </div>
              <div class="form-group">
                <label for="task-description-input">Descripción:</label>
                <textarea id="task-description-input" class="form-textarea"></textarea>
              </div>
              <div class="form-group">
                <label for="task-category-input">Categoría:</label>
                <select id="task-category-input">
                  <option value="work">Trabajo</option>
                  <option value="personal">Personal</option>
                  <option value="study">Estudio</option>
                </select>
              </div>
              <div class="form-group">
                <label for="task-deadline-input">Fecha Límite:</label>
                <input type="date" id="task-deadline-input">
              </div>
              <div class="form-group">
                <label for="task-status-input">Estado:</label>
                <select id="task-status-input">
                  <option value="pending">Pendiente</option>
                  <option value="completed">Completada</option>
                </select>
              </div>
              <div class="form-group">
                <label for="task-list-input">Lista:</label>
                <select id="task-list-input">
                  <option value="">Ninguna</option>
                  <!-- Opciones de lista se añadirán aquí dinámicamente -->
                </select>
              </div>
              <div class="form-actions">
                <button type="button" class="btn btn-secondary" id="cancel-task">Cancelar</button>
                <button type="submit" class="btn btn-primary">Guardar</button>
              </div>
            </div>
          </form>
        </div>
      </div>

      <!-- Modal para añadir listas -->
      <div class="modal" id="list-modal">
        <div class="modal-content">
          <div class="modal-header">
            <h2 class="modal-title" id="list-modal-title">Añadir Lista</h2>
            <button class="close-modal" id="close-list-modal">&times;</button>
          </div>
          <form id="list-form">
            <div class="modal-body">
              <input type="hidden" id="list-id">
              <div class="form-group">
                <label for="list-title-input">Título de la Lista:</label>
                <input type="text" id="list-title-input" required>
              </div>
              <div class="form-group">
                <label for="list-description-input">Descripción:</label>
                <textarea id="list-description-input" class="form-textarea"></textarea>
              </div>
              <div class="form-actions">
                <button type="button" class="btn btn-secondary" id="cancel-list">Cancelar</button>
                <button type="submit" class="btn btn-primary">Guardar</button>
              </div>
            </div>
          </form>
        </div>
      </div>
    </main>
  </div>

  <script src="scripts/tareas-compartidas.js"></script>
  <script>
    // Verificar si el script de tareas compartidas se cargó correctamente
    if (typeof cargarTareas !== 'function') {
      console.error('Error: No se pudo cargar el archivo tareas-compartidas.js');
      // Definir funciones de respaldo
      function cargarTareas() {
        console.warn('Usando función de respaldo para cargarTareas');
        const tareasGuardadas = localStorage.getItem('tareas');
        return tareasGuardadas ? JSON.parse(tareasGuardadas) : [];
      }
      
      function guardarTareas(tareas) {
        console.warn('Usando función de respaldo para guardarTareas');
        localStorage.setItem('tareas', JSON.stringify(tareas));
      }
      
      function obtenerTextoCategoria(categoria) {
        console.warn('Usando función de respaldo para obtenerTextoCategoria');
        switch (categoria) {
          case 'work': return 'Trabajo';
          case 'personal': return 'Personal';
          case 'study': return 'Estudio';
          default: return categoria;
        }
      }
    }
  
    // Mobile menu toggle
    const mobileMenuToggle = document.getElementById('mobile-menu-toggle');
    const sidebar = document.getElementById('sidebar');
    
    mobileMenuToggle.addEventListener('click', () => {
      sidebar.classList.toggle('open');
    });
    
    // Notificaciones toggle
    const notificationToggle = document.getElementById('notification-toggle');
    const notificationPanel = document.getElementById('notification-panel');
    const closeNotifications = document.getElementById('close-notifications');
    
    // Añadir evento click al botón de notificaciones
    notificationToggle.addEventListener('click', (event) => {
      // Detener la propagación del evento para evitar que se cierre inmediatamente
      event.stopPropagation();
      notificationPanel.classList.toggle('open');
    });
    
    // Añadir evento click al botón de cerrar notificaciones
    closeNotifications.addEventListener('click', () => {
      notificationPanel.classList.remove('open');
    });
    
    // Cerrar notificaciones al hacer clic fuera del panel
    document.addEventListener('click', (event) => {
      // Verificar si el clic fue fuera del panel y del botón de notificaciones
      if (!notificationPanel.contains(event.target) && event.target !== notificationToggle && !notificationToggle.contains(event.target)) {
        notificationPanel.classList.remove('open');
      }
    });
    
    // Cargar tareas iniciales
    let tareas = cargarTareas();
    console.log('Tareas cargadas:', tareas); // Para depuración
    
    // Si no hay tareas guardadas, usar las de ejemplo
    if (tareas.length === 0) {
      tareas = [
        {
          id: "1",
          name: "Completar informe trimestral",
          description: "Finalizar el informe para la reunión del viernes",
          category: "work",
          deadline: "2025-05-15",
          status: "pending"
        },
        {
          id: "2",
          name: "Comprar víveres",
          description: "Comprar alimentos para la semana",
          category: "personal",
          deadline: "2025-05-10",
          status: "completed"
        },
        {
          id: "3",
          name: "Estudiar para examen",
          description: "Repasar los temas del capítulo 5 al 8",
          category: "study",
          deadline: "2025-05-20",
          status: "pending"
        },
        {
          id: "4",
          name: "Juga maincra",
          description: "Jugar minecraft con los amigos",
          category: "work",
          deadline: "2025-05-13",
          status: "pending"
        },
        {
          id: "5",
          name: "Escuchar deftones",
          description: "Escuchar el nuevo álbum de Deftones",
          category: "study",
          deadline: "2025-05-15",
          status: "pending"
        },
        {
          id: "6",
          name: "Salida del closet del cumberto",
          description: "Apoyar a Cumberto en su salida del closet",
          category: "personal",
          deadline: "2025-05-19",
          status: "pending"
        },
        {
          id: "7",
          name: "Cumberto",
          description: "Ayudar a Cumberto con sus tareas",
          category: "personal",
          deadline: "2025-05-15",
          status: "pending"
        }
      ];
      guardarTareas(tareas);
      console.log('Tareas de ejemplo guardadas');
    }
    
    // Actualizar la tabla con las tareas
    function actualizarTablaTareas() {
      const taskList = document.querySelector('#task-list tbody');
      if (!taskList) {
        console.error('Error: No se encontró el elemento #task-list tbody');
        return;
      }
      
      taskList.innerHTML = '';
      
      // Filtrar tareas según los filtros seleccionados
      let tareasFiltradas = [...tareas];
      
      const statusFilter = document.getElementById('filter-status');
      const categoryFilter = document.getElementById('filter-category');
      const searchText = document.getElementById('search-task');
      
      if (statusFilter && statusFilter.value !== 'all') {
        tareasFiltradas = tareasFiltradas.filter(tarea => tarea.status === statusFilter.value);
      }
      
      if (categoryFilter && categoryFilter.value !== 'all') {
        tareasFiltradas = tareasFiltradas.filter(tarea => tarea.category === categoryFilter.value);
      }
      
      if (searchText && searchText.value) {
        const searchValue = searchText.value.toLowerCase();
        tareasFiltradas = tareasFiltradas.filter(tarea => 
          tarea.name.toLowerCase().includes(searchValue)
        );
      }
      
      // Mostrar mensaje si no hay tareas
      const noTasksMessage = document.getElementById('no-tasks-message');
      const taskTableContainer = document.getElementById('task-table-container');
      
      if (tareasFiltradas.length === 0) {
        if (noTasksMessage) noTasksMessage.style.display = 'flex';
        if (taskTableContainer) taskTableContainer.style.display = 'none';
      } else {
        if (noTasksMessage) noTasksMessage.style.display = 'none';
        if (taskTableContainer) taskTableContainer.style.display = 'block';
        
        // Añadir cada tarea a la tabla
        tareasFiltradas.forEach(tarea => {
          const row = document.createElement('tr');
          row.id = `task-${tarea.id}`;
          row.className = 'task-item';
          row.setAttribute('data-status', tarea.status);
          row.setAttribute('data-category', tarea.category);
          row.setAttribute('data-description', tarea.description || '');
          
          // Obtener texto de categoría
          const categoriaTexto = obtenerTextoCategoria(tarea.category);
          
          row.innerHTML = `
            <td class="task-name">${tarea.name}</td>
            <td class="task-category">${categoriaTexto}</td>
            <td class="task-deadline">${tarea.deadline}</td>
            <td class="task-status">
              <span class="status-badge ${tarea.status}">
                ${tarea.status === 'completed' ? 'Completada' : 'Pendiente'}
              </span>
            </td>
            <td class="task-actions">
              <button class="btn-icon btn-edit" data-task-id="${tarea.id}">
                <i class='bx bx-edit'></i>
              </button>
              <button class="btn-icon btn-complete" data-task-id="${tarea.id}" ${tarea.status === 'completed' ? 'disabled' : ''}>
                <i class='bx bx-check'></i>
              </button>
              <button class="btn-icon btn-delete" data-task-id="${tarea.id}">
                <i class='bx bx-trash'></i>
              </button>
            </td>
          `;
          
          taskList.appendChild(row);
        });
        
        // Añadir event listeners a los botones
        document.querySelectorAll('.btn-edit').forEach(button => {
          button.addEventListener('click', function() {
            const taskId = this.getAttribute('data-task-id');
            editarTarea(taskId);
          });
        });
        
        document.querySelectorAll('.btn-complete').forEach(button => {
          button.addEventListener('click', function() {
            const taskId = this.getAttribute('data-task-id');
            completarTarea(taskId);
          });
        });
        
        document.querySelectorAll('.btn-delete').forEach(button => {
          button.addEventListener('click', function() {
            const taskId = this.getAttribute('data-task-id');
            eliminarTarea(taskId);
          });
        });
      }
    }
    
    // Función para editar una tarea
    function editarTarea(taskId) {
      const tarea = tareas.find(t => t.id === taskId);
      if (!tarea) return;
      
      const modalTitle = document.getElementById('modal-title');
      const taskIdInput = document.getElementById('task-id');
      const taskNameInput = document.getElementById('task-name-input');
      const taskDescriptionInput = document.getElementById('task-description-input');
      const taskCategoryInput = document.getElementById('task-category-input');
      const taskDeadlineInput = document.getElementById('task-deadline-input');
      const taskStatusInput = document.getElementById('task-status-input');
      const taskListInput = document.getElementById('task-list-input');
      const taskModal = document.getElementById('task-modal');
      
      if (modalTitle) modalTitle.textContent = 'Editar Tarea';
      if (taskIdInput) taskIdInput.value = tarea.id;
      if (taskNameInput) taskNameInput.value = tarea.name;
      if (taskDescriptionInput) taskDescriptionInput.value = tarea.description || '';
      if (taskCategoryInput) taskCategoryInput.value = tarea.category;
      if (taskDeadlineInput) taskDeadlineInput.value = tarea.deadline;
      if (taskStatusInput) taskStatusInput.value = tarea.status;
      if (taskListInput) taskListInput.value = tarea.list || '';
      
      if (taskModal) taskModal.classList.add('open');
    }
    
    // Función para completar una tarea
    function completarTarea(taskId) {
      tareas = tareas.map(tarea => 
        tarea.id === taskId ? { ...tarea, status: 'completed' } : tarea
      );
      
      guardarTareas(tareas);
      actualizarTablaTareas();
    }
    
    // Función para eliminar una tarea
    function eliminarTarea(taskId) {
      if (confirm('¿Estás seguro de que deseas eliminar esta tarea?')) {
        tareas = tareas.filter(tarea => tarea.id !== taskId);
        guardarTareas(tareas);
        actualizarTablaTareas();
      }
    }
    
    // Modal para tareas
    const taskModal = document.getElementById('task-modal');
    const closeModal = document.getElementById('close-modal');
    const cancelTask = document.getElementById('cancel-task');
    const btnAddTask = document.getElementById('btn-add-task');
    
    if (btnAddTask) {
      btnAddTask.addEventListener('click', () => {
        const modalTitle = document.getElementById('modal-title');
        const taskIdInput = document.getElementById('task-id');
        const taskNameInput = document.getElementById('task-name-input');
        const taskDescriptionInput = document.getElementById('task-description-input');
        const taskCategoryInput = document.getElementById('task-category-input');
        const taskDeadlineInput = document.getElementById('task-deadline-input');
        const taskStatusInput = document.getElementById('task-status-input');
        const taskListInput = document.getElementById('task-list-input');
        
        if (modalTitle) modalTitle.textContent = 'Nueva Tarea';
        if (taskIdInput) taskIdInput.value = '';
        if (taskNameInput) taskNameInput.value = '';
        if (taskDescriptionInput) taskDescriptionInput.value = '';
        if (taskCategoryInput) taskCategoryInput.value = 'work';
        if (taskDeadlineInput) taskDeadlineInput.value = '';
        if (taskStatusInput) taskStatusInput.value = 'pending';
        if (taskListInput) taskListInput.value = '';
        
        if (taskModal) taskModal.classList.add('open');
      });
    }
    
    if (closeModal) {
      closeModal.addEventListener('click', () => {
        if (taskModal) taskModal.classList.remove('open');
      });
    }
    
    if (cancelTask) {
      cancelTask.addEventListener('click', () => {
        if (taskModal) taskModal.classList.remove('open');
      });
    }
    
    // Modal para listas
    const listModal = document.getElementById('list-modal');
    const closeListModal = document.getElementById('close-list-modal');
    const cancelList = document.getElementById('cancel-list');
    const btnAddList = document.getElementById('btn-add-list');
    
    if (btnAddList) {
      btnAddList.addEventListener('click', () => {
        const listModalTitle = document.getElementById('list-modal-title');
        const listIdInput = document.getElementById('list-id');
        const listTitleInput = document.getElementById('list-title-input');
        const listDescriptionInput = document.getElementById('list-description-input');
        
        if (listModalTitle) listModalTitle.textContent = 'Nueva Lista';
        if (listIdInput) listIdInput.value = '';
        if (listTitleInput) listTitleInput.value = '';
        if (listDescriptionInput) listDescriptionInput.value = '';
        
        if (listModal) listModal.classList.add('open');
      });
    }
    
    if (closeListModal) {
      closeListModal.addEventListener('click', () => {
        if (listModal) listModal.classList.remove('open');
      });
    }
    
    if (cancelList) {
      cancelList.addEventListener('click', () => {
        if (listModal) listModal.classList.remove('open');
      });
    }
    
    // Guardar tarea
    const taskForm = document.getElementById('task-form');
    if (taskForm) {
      taskForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const taskId = document.getElementById('task-id').value;
        const taskName = document.getElementById('task-name-input').value;
        const taskDescription = document.getElementById('task-description-input').value;
        const taskCategory = document.getElementById('task-category-input').value;
        const taskDeadline = document.getElementById('task-deadline-input').value;
        const taskStatus = document.getElementById('task-status-input').value;
        const taskList = document.getElementById('task-list-input').value;
        
        const nuevaTarea = {
          id: taskId || Date.now().toString(),
          name: taskName,
          description: taskDescription,
          category: taskCategory,
          deadline: taskDeadline,
          status: taskStatus,
          list: taskList
        };
        
        if (taskId) {
          // Actualizar tarea existente
          tareas = tareas.map(tarea => tarea.id === taskId ? nuevaTarea : tarea);
        } else {
          // Añadir nueva tarea
          tareas.push(nuevaTarea);
        }
        
        guardarTareas(tareas);
        actualizarTablaTareas();
        if (taskModal) taskModal.classList.remove('open');
      });
    }
    
    // Guardar lista
    const listForm = document.getElementById('list-form');
    if (listForm) {
      listForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const listTitle = document.getElementById('list-title-input').value;
        
        // Aquí podrías guardar la lista en localStorage también
        
        // Actualizar el selector de listas en el formulario de tareas
        const listSelect = document.getElementById('task-list-input');
        if (listSelect) {
          const newOption = document.createElement('option');
          newOption.value = `list-${Date.now()}`;
          newOption.textContent = listTitle;
          listSelect.appendChild(newOption);
        }
        
        alert(`Lista "${listTitle}" creada exitosamente`);
        if (listModal) listModal.classList.remove('open');
      });
    }
    
    // Filtros
    const filterStatus = document.getElementById('filter-status');
    const filterCategory = document.getElementById('filter-category');
    const btnSearch = document.getElementById('btn-search');
    const searchTask = document.getElementById('search-task');
    
    if (filterStatus) filterStatus.addEventListener('change', actualizarTablaTareas);
    if (filterCategory) filterCategory.addEventListener('change', actualizarTablaTareas);
    if (btnSearch) btnSearch.addEventListener('click', actualizarTablaTareas);
    if (searchText) {
      searchTask.addEventListener('keyup', function(e) {
        if (e.key === 'Enter') {
          actualizarTablaTareas();
        }
      });
    }
    
    // Inicializar la tabla de tareas
    document.addEventListener('DOMContentLoaded', function() {
      console.log('DOM cargado, inicializando tabla de tareas');
      actualizarTablaTareas();
    });
    
    // Inicializar la tabla de tareas inmediatamente también
    console.log('Inicializando tabla de tareas inmediatamente');
    actualizarTablaTareas();
  </script>
</body>
</html>
